<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,900' rel='stylesheet'
        type='text/css'>
    <link href="StyleSheet1.css" rel="stylesheet" />
    <link href="musicbars.css" rel="stylesheet" />
    <title></title>
</head>
<body>
    <div class="techfestbar">
        <div id="topdiv">
        </div>
        <span id="pagetitle">techfest - 2013</span>
        <div id="authorBar">
            <div class="parent Vibhor">
                <div class="image-blur-Vibhor">
                </div>
                <div class="image-Vibhor">
                </div>
                <div class="image-description">
                    Vibhor Gupta<br />
                    1810
                </div>
            </div>
            <div class="parent Prateek">
                <div class="image-blur-Prateek">
                </div>
                <div class="image-Prateek">
                </div>
                <div class="image-description">
                    Prateek Kumar Pradeep<br />
                    1876
                </div>
            </div>
            <div class="parent Anubhav">
                <div class="image-blur-Anubhav">
                </div>
                <div class="image-Anubhav">
                </div>
                <div class="image-description">
                    Anubhav Saxena<br />
                    2197
                </div>
            </div>
        </div>
    </div>
    <div class="chapterbar">
        <div class="horizontalrule">
        </div>
        <div id="chapterselection1" class="chapterselection" style="float: left; margin-left: 20%;
            text-shadow: 0px 1px 0px rgba(255,255,255,.5);">
            1</div>
        <div id="chapterselection3" class="chapterselection" style="float: right; margin-right: 20%;">
            3</div>
        <div id="chapterselection2" class="chapterselection" style="margin: 0 auto;">
            2</div>
    </div>
    <div id="chapter1" class="chapter" style="display: none;">
        <div id="noscale" style="position: relative;">
            <div id="recording">
            </div>
            <div id="mic">
                <img src="Images/microphone.png" style="height: 40px;" />
            </div>
        </div>
        <div class="commandRecogniser">
            <div class="logocontainer">
                <span id="command_span"></span>
            </div>
        </div>
        <div class="txtbox">
            <span id="final_span"></span><span id="interim_span" style="color: grey"></span>
        </div>
    </div>
    <div id="chapter2" class="chapter" style="display: none;">
        <img id="cam" src="Images/default.jpg" />
    </div>
    <div id="chapter3" class="chapter" style="display: none;">
        <div id="musicBarContainer" class="container" style="visibility: hidden">
            <div class="blockcontainer">
                <div class="block gray block1" id="block1">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block2" id="block2">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block3" id="block3">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block4" id="block4">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block5" id="block5">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block6" id="block6">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block7" id="block7">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block8" id="block8">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block9" id="block9">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block10" id="block10">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block3" id="block11">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block8" id="block14">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block1" id="block12">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block4" id="block13">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block9" id="block15">
                </div>
            </div>
            <div class="blockcontainer">
                <div class="block gray block6" id="block16">
                </div>
            </div>
        </div>
        <div class="commandRecogniser">
            <div class="logocontainer">
                <span id="command_span2">Wave</span>
            </div>
        </div>
        <div class="txtbox" style="text-align: center">
            <span id="lyrics" style="word-wrap: normal;">Hello</span>
            <input type="hidden" id="txt" />
        </div>
        <span style="display: none" id="time"></span>
    </div>
    <div class="blankbar">
    </div>
    <div class="controlbar">
        <div class="buttons">
            <div class="btn-toolbar" style="float: left; margin-left: 50px;">
                <div class="btn-group">
                    <button class="btn" data-action="move" data-param="front">
                        <i class="icon-arrow-up"></i>Front</button>
                    <button class="btn" data-action="move" data-param="back">
                        <i class="icon-arrow-down"></i>Back</button>
                </div>
                <div class="btn-group">
                    <button class="btn" data-action="move" data-param="left">
                        <i class="icon-arrow-left"></i>Left</button>
                    <button class="btn" data-action="move" data-param="right">
                        <i class="icon-arrow-right"></i>Right</button>
                </div>
                <input class="span1" id="duration" size="3" type="hidden" value="2" rel="tooltip"
                    data-placement="bottom" title="Trigger animations. You can change the duration of an animation. It defaults to 2 seconds.">
            </div>
            <div class="btn-toolbar" style="float: left; margin-left: 25px;">
                <div class="btn-group">
                    <button class="btn" data-action="move" data-param="up">
                        <i class="icon-chevron-up"></i>Up</button>
                        <button class="btn" data-action="move" data-param="counterClockwise" style=" font-size:17px;">
                        <i class="icon-refresh"></i>Anti clockwise</button>
                    
                </div>
                <div class="btn-group">
                <button class="btn" data-action="move" data-param="down">
                        <i class="icon-chevron-down"></i>Down</button>
                    <button class="btn" data-action="move" data-param="clockwise" style=" font-size:17px;">
                        <i ></i>Clockwise</button>
                    
                </div>
            </div>
            <div class="btn-toolbar" style="float: left; margin-top: 15px; margin-left: 50px;">
                <div class="input-append btn-group">
                    <button class="btn btn-success" data-action="drone" data-param="takeoff" style="background-color: #7FFF00;">
                        <i class="icon-play icon-white"></i>takeoff</button>
                    <button class="btn btn-warning" data-action="drone" data-param="land">
                        <i class="icon-stop icon-white"></i>land</button>
                    <button class="btn btn-danger" data-action="drone" data-param="disableEmergency">
                        <i class="icon-wrench icon-white"></i>recover</button>
                    <button class="btn btn-success" data-action="drone" data-param="stop" style="background-color: #FF4500">
                        <i class="icon-play icon-white"></i>stop</button>
                    <div id="EnableDetection">
                        <section>
                            <div class="checkboxFive">
                                <input type="checkbox" value="1" id="chkDetect" name="" />
                                <label for="chkDetect">
                                </label>
                            </div>
                        </section>
                        <span class="Detect">Head Tracking</span>
                    </div>
                </div>
            </div>
            <div class="music-btn-group" style="float: right; margin-right: 80px;">
                <div>
                    <button id="startBtn" class="custombtn" onclick="beginPlay()">
                        <div class="arrow-right">
                        </div>
                    </button>
                    <button id="stopBtn" class="custombtn" onclick="stopPlay()" disabled>
                        <div class="rectangle">
                        </div>
                    </button>
                </div>
                <div>
                    <div style="display: none">
                        <input type="file" id="fileinput" />
                    </div>
                    <div style="position: absolute;">
                        <input id="lyricsinput" type="button" class="custombtn" value="Select File" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="components/jquery/jquery.js" type="text/javascript"></script>
    <script src="jquery-1.7.min.js" type="text/javascript"></script>
    <script src="jquery-ui-1.8.16.custom.min.js" type="text/javascript"></script>
    <script src="UImod.js"></script>
    <script src="time.js" type="text/javascript"></script>
    <script src="/faye/client.js" type="text/javascript"></script>
    <script src="components/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="client.js" type="text/javascript"></script>
    <script src="annyang.js" type="text/javascript"></script>
    <script type="text/javascript" src="ccv.js"></script>
    <script type="text/javascript" src="face.js"></script>
    <script>
        var motionTimeout = 3;
        if (annyang) {
            var commands = {
                'up': function () {
                    var actn = 'move';
                    droneMotion(true, actn, 'up');
                },
                'stop': function () {
                    var actn = 'move';
                    droneMotion(false, actn, 'stop');
                },
                'down': function () {
                    var actn = 'move';
                    droneMotion(true, actn, 'down');
                },
                'front': function () {
                    var actn = 'move';
                    droneMotion(true, actn, 'front');
                },
                'back': function () {
                    var actn = 'move';
                    droneMotion(true, actn, 'back');
                },
                'launch': function () {
                    var actn = 'drone';
                    droneMotion(false, actn, 'takeoff');
                },
                'land': function () {
                    var actn = 'drone';
                    droneMotion(false, actn, 'land');
                },
                '1': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiM30Deg', motionTimeout);
                },
                '2': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phi30Deg', motionTimeout);
                },
                '3': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'thetaM30Deg', motionTimeout);
                },
                '4': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta30Deg', motionTimeout);
                },
                '5': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta20degYaw200deg', motionTimeout);
                },
                '6': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta20degYawM200deg', motionTimeout);
                },
                '7': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'turnaround', motionTimeout);
                },
                '8': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'turnaroundGodown', motionTimeout);
                },
                '9': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'yawShake', motionTimeout);
                },
                '10': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'yawDance', motionTimeout);
                },
                '11': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiDance', motionTimeout);
                },
                '12': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'thetaDance', motionTimeout);
                },
                '13': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'vzDance', motionTimeout);
                },
                '14': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'wave', motionTimeout);
                },
                '15': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiThetaMixed', motionTimeout);
                },
                '16': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'doublePhiThetaMixed', motionTimeout);
                },
                '19': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'flipLeft', motionTimeout);
                },
                '20': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'flipRight', motionTimeout);
                },
                'refresh': function () {
                    final_span.innerText = '';
                    interim_span.innerText = '';
                    command_span.innerText = '';
                },
                'Presenting': function () {
                    var actn = 'drone';
                    droneMotion(true, actn, 'takeoff');
                },
                'bleed': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiM30Deg', motionTimeout);
                },
                'stars': function () {
                    var actn = 'move';
                    droneMotion(false, actn, 'up');
                },
                'shine': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiDance', 0.3);
                    ledAnimate();
                },
                'along': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'thetaM30Deg', motionTimeout);
                },
                'song': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta30Deg', motionTimeout);
                },
                'thing': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiDance', motionTimeout);
                },
                'turn': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'turnaround', motionTimeout);
                },
                'everything': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'wave', 0.3);
                },
                'things': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'wave', motionTimeout);
                },
                'skin': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'phiThetaMixed', motionTimeout);
                },
                'beautiful': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'doublePhiThetaMixed', motionTimeout);
                },
                'know': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'thetaDance', motionTimeout);
                },
                'ColdPlay': function () {
                    var actn = 'animate';
                    droneMotion(false, actn, 'doublePhiThetaMixed', 4);
                },
                'what': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'doublePhiThetaMixed', motionTimeout);
                },
                'jumped': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'flipRight', motionTimeout);
                },
                'swam': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'flipLeft', motionTimeout);
                },
                'yellow': function () {
                    var actn = 'animate';
                    droneMotion(true, actn, 'turnaround', motionTimeout);
                }
            };
        }

        annyang.init(commands);
        annyang.start();
        function BufferLoader(context, urlList, callback) {
            this.context = context;
            this.urlList = urlList;
            this.onload = callback;
            this.bufferList = new Array();
            this.loadCount = 0;
            this.load = function () {
                for (var i = 0; i < this.urlList.length; ++i)
                    this.loadBuffer(this.urlList[i], i);
            }
            this.loadBuffer = function (url, index) {
                // Load buffer asynchronously
                var request = new XMLHttpRequest();
                request.open("GET", url, true);
                request.responseType = "arraybuffer";

                var loader = this;

                request.onload = function () {
                    // Asynchronously decode the audio file data in request.response
                    loader.context.decodeAudioData(
                  request.response,
                  function (buffer) {
                      if (!buffer) {
                          alert('error decoding file data: ' + url);
                          return;
                      }
                      loader.bufferList[index] = buffer;
                      if (++loader.loadCount == loader.urlList.length)
                          loader.onload(loader.bufferList);
                  },
                  function (error) {
                      console.error('decodeAudioData error', error);
                  }
                );
                }

                request.onerror = function () {
                    alert('BufferLoader: XHR error');
                }

                request.send();
            }

        }

        window.onload = init;
        var context;
        var bufferLoader;

        function init() {
            // Fix up prefixing
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            context = new AudioContext();

            bufferLoader = new BufferLoader(
              context,
              [
                '05 Yellow.mp3'
              ],
              finishedLoading
              );

            bufferLoader.load();
        }

        function finishedLoading(bufferList) {
            // Create two sources and play them both together.
            source1 = context.createBufferSource();
            source1.buffer = bufferList[0];

            source1.connect(context.destination);
            $('#lyrics').text('Done');
            //source1.start(0);
        }

        //var ticks = 0;
        //var m = 0;
        //var s = 0;
        //var ms = 0;

        lines = new Array();

        function lyricsMatched() {
            var format = time.innerText;
            if (lines[0] != undefined) {
                if (format == lines[0].substring(0, 7)) {
                    commandLine = lines[0].substring(7, lines[0].length - 1);
                    //debugger;
                    $('#lyrics').text(commandLine);
                    annyang.playMusic(commandLine);
                    lines.splice(0, 1);
                }
            }
        }



        function launchTimeWorker() {
            var worker = new Worker('time.js');
            debugger;
            worker.onmessage = function (e) {
                document.getElementById("time").innerText = e.data.Time;
                lyricsMatched();
            };
            worker.onerror = function (e) {
                alert('Error: Line ' + e.lineno + ' in ' + e.filename + ': ' + e.message);
            };

            //start the worker
            worker.postMessage({
                'start': 'start',
                'line': lines
            });
        }

        function beginPlay() {
            //debugger;
            //t = setInterval(function () { startTime(); }, 10);
            launchTimeWorker();
            $('#musicBarContainer').css({ 'visibility': 'visible' });
            //launchMotion();
            $('#stopBtn').removeAttr('disabled');
            source1.start(0);
        }

        //function startTime() {
        //    ticks += 1;
        //    s = parseInt(s);
        //    m = parseInt(m);
        //    ms = parseInt(ms);
        //    if (ticks > 100) {
        //        s = s + 1;
        //        ticks = 0;
        //    }
        //    if (s > 60) {
        //        m = m + 1;
        //        s = 0;
        //    }
        //    ms = ticks;
        //    // add a zero in front of numbers<10
        //    m = checkTime(m);
        //    s = checkTime(s);
        //    ms = checkTime(ms);
        //    var format = '[' + m + ":" + s + "." + ms + ']';
        //    document.getElementById('txt').innerHTML = format;
        //    time.innerText = format;
        //    if (lines[0] != undefined) {
        //        if (format == lines[0].substring(0, 10)) {
        //            commandLine = lines[0].substring(10, lines[0].length - 1);
        //            //debugger;
        //            $('#lyrics').text(commandLine);
        //            annyang.playMusic(commandLine);
        //            lines.splice(0, 1);
        //        }
        //    }
        //}

        //function checkTime(i) {
        //    if (i < 10) {
        //        i = "0" + i;
        //    }
        //    return i;
        //}

        function stopPlay() {
            clearInterval(t);
            source1.stop(0);
            $('#musicBarContainer').css({ 'visibility': 'hidden' });
            landDrone();
        }

        function readSingleFile(evt) {
            //Retrieve the first (and only!) File from the FileList object
            var f = evt.target.files[0];

            if (f) {
                var r = new FileReader();
                r.onload = function (e) {
                    var contents = e.target.result;
                    lines = contents.split('\n');
                    //debugger;
                }
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        }

        document.getElementById('fileinput').addEventListener('change', readSingleFile, false);
    </script>
    <script type="text/javascript">
        var previousrect;
        var isDetectEnable = false;
        var divId = 1;

        $.fn.highlight = function (rect, color) {
            $("#" + (divId - 1).toString()).css("border", "2px solid blue");
            $("<div/>", {
                "css": {
                    "border": "2px solid " + color,
                    "position": "absolute",
                    "width": rect.width + "px",
                    "height": rect.height + "px",
                    "left": ($('#cam').offset().left + rect.x) + "px",
                    "top": ($('#cam').offset().top + rect.y) + "px",
                }
            }).attr("id", divId).appendTo("body");
            divId++;
        }

        $(document).ready(function () {
            var timer = setTimeout("detectFace()", 3000);
        });

        function detectFace() {
            if (isDetectEnable) {
                var image = new Image();
                image.onload = function () {
                    /* load image, and draw it to canvas */
                    function post(comp) {
                        if (comp.length > 0) {
                            MoveAfterDetection(comp[0]);
                            previousrect = comp[0];
                            $("cam").highlight(comp[0], "red");
                        }
                    }
                    /* call main detect_objects function */

                    var comp = ccv.detect_objects({
                        "canvas": ccv.grayscale(ccv.pre(image)),
                        "cascade": cascade,
                        "interval": 5,
                        "min_neighbors": 1
                    });
                    post(comp);
                };
                image.src = $('#cam').prop('src');
                timer = setTimeout("detectFace()", 3000);
            }
            else {
                timer = setTimeout("detectFace()", 3000);
            }
        }

        function MoveAfterDetection(rect) {
            if (previousrect != undefined && rect != undefined) {
                isDetectEnable = false;
                var differneceinHorizontal = rect.x - previousrect.x;
                var differneceinVertical = rect.y - previousrect.y;
                $("#" + (divId - 2).toString()).remove();
                if (differneceinVertical > 50) {
                    $("#command_span").text("Down" + differneceinVertical);
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta20degYaw200deg', motionTimeout);
                }
                else if (differneceinVertical < -50) {
                    $("#command_span").text("Up" + differneceinVertical);
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta20degYaw200deg', motionTimeout);
                }
                else if (differneceinHorizontal > 50) {
                    $("#command_span").text("Right" + differneceinHorizontal);
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta20degYawM200deg', motionTimeout);
                }
                else if (differneceinHorizontal < -50) {
                    $("#command_span").text("Left" + differneceinHorizontal);
                    var actn = 'animate';
                    droneMotion(true, actn, 'theta20degYawM200deg', motionTimeout);
                }
                isDetectEnable = true;
            }
        }


        $('#chkDetect').click(function () {
            isDetectEnable = this.checked;
        });
    </script>
</body>
</html>
